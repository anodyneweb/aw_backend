{% extends "layout.html" %} {% load static %}
{% block content %}
<link rel="stylesheet" type="text/css" href="/static/css/cards.min.css">


<div class="col-sm-6">
    <span id="view_name" hidden>Map View</span>

    <div class="col-12 geolocation-details">
    <p>Select the industry</p>
    <div class="row p-15">
        <select title="Industry" id="iList" class="form-control col-md-5 select" onchange="GetSites(this);">
                {% for industry in industries %}
                <option value={{industry.uuid}}>{{industry}}</option>
                {% endfor %}
        </select>
        <br>
        <!--<span id="loader" style="visibility: hidden;">&nbsp;&nbsp;&nbsp;Please wait...&nbsp;<img src="/static/img/loader.gif" class="loader" height="20" width="20"></span>-->
        <span id="loader" style="visibility: hidden; padding:5px">&nbsp;&nbsp;&nbsp;Please wait...&nbsp;<img src="/static/img/loader.gif" class="loader" height="20" width="20"></span>
    </div>

    <p id="site_dd_p" hidden></p>
    <div class="row p-15" id="site_dd" style="display:none">
        <select id="sList" class="form-control col-5 select m-r-10"
                onchange="GetSiteDetails(this);"></select>
    </div>

    <div class="panel-body" id="siteinfotable" hidden>
        <h3 id="site_name_header">Site Details</h3>
        <div class="table-responsive">
            <table class="table">
                <tbody id="records_table"> </tbody>
            </table>
        </div>
    </div>
</div>
</div>
<div class="col-sm-12" id="geo">
    <div id="sitesMap" class="col">
    </div>
</div>

{% endblock %} {% block scripts %}
<link href="/static/css/gijgo.min.css" rel="stylesheet" type="text/css">
<script type="text/javascript" src="/static/js/gijgo.min.js"></script>
<script type="text/javascript" src="/static/js/jquery.csv-0.71.min.js"></script>

<style type="text/css">
    #sitesMap {
        height: 800px;
        top: 20px;
        border: 1px dashed;
    }

    .geolocation-details{
        padding-top: 15px;
        padding-bottom: 15px;
    }

    .inf-content {
        border: 1px solid #DDDDDD;
        -webkit-border-radius: 10px;
        -moz-border-radius: 10px;
        border-radius: 10px;
        box-shadow: 7px 7px 7px rgba(0, 0, 0, 0.3);
    }

    #siteinfotable {
        text-align: initial;
    }

    .card-accent-primary {
        border-top-color: #017a75;
        border-top-width: 3px;
    }

    .card-header {
        background-color: #f0f3f5;
        border-bottom: 1px solid #c8ced3;
    }

    .card-body {
        padding: 1.25rem;
    }

    .card {
        padding: 0;
    }

    #siteinfotable tbody tr td:last-child {
        text-align: initial;
    }

    #siteinfotable .table tr:first-of-type td {
        border-top: none;
    }

    #siteinfotable .table td,
    #siteinfotable .table th {
        padding: 0.4rem 0.55rem;
    }
</style>

<script type="text/javascript">
var loader = document.getElementById('loader');
    function GetSites(industry) {
        if (industry.value != null && industry.value != '')
        {
            var $sites = $("#sList");
            loader.style.visibility = "visible";
        $.ajax({
            url: "/dashboard/GetSites?industry=" + industry.value
        }).done(function(details) {

            $sites.empty(); // remove old options
            $.each(details.sites, function(key, value) {
                $sites.append($("<option></option>").attr("value", value.uuid).text(value.name));
            });
            if (details.sites.length > 0) {
                $("#site_dd").show();
                $('#site_dd_p').removeAttr('style').text('choose site for info.')
                $("#site_dd_p").show();
                GetSiteDetails(details.sites[0]);
                loader.style.visibility = "hidden";
            } else {
                $("#site_dd").hide();
                $("#geo").hide();
                $('#site_dd_p').css("color", "red").text('no site available under this industry')
                $("#site_dd_p").show();
                $('#siteinfotable').hide();
                loader.style.visibility = "hidden";
            }

        });
            }else{
                $("#site_dd").hide();
                $("#geo").hide();
                $("#site_dd_p").hide();
                $('#siteinfotable').hide();
                loader.style.visibility = "hidden";
            }
    }

    function GetSiteDetails(s) {
        var site;
        if (s.uuid == null) {
            site = s.value;
        } else {
            site = s.uuid;
        }
        loader.style.visibility = "visible";
        $.ajax({
            url: "/dashboard/GetSiteDetails?site=" + site
        }).done(function(details) {
            var lt = details.latitude[1];
            var lg = details.longitude[1];
            $("#site_name_header").text(details.name[1]);
            $('#records_table').empty();
            $.each(details, function(key, value) {
                var $tr = $('<tr>').append(
                    $("<td style='width:40%; background-color: #f2f2f2;'>").text(value[0]),
                    $('<td>').text(value[1]),
                ).appendTo('#records_table');
            });
            loader.style.visibility = "hidden";
            $('#siteinfotable').show();
            myMap(details);
            console.log(details);
            $('#geo').show();
        });
    }

    var map;
    function myMap(site) {
    if(typeof site === "undefined"){
        // do nothing
	  }else {
        var icon = {
            url: "/static/img/marker/marker_red.png",
            scaledSize: new google.maps.Size(34, 35), // scaled size
            origin: new google.maps.Point(0, 0), // origin
            anchor: new google.maps.Point(0, 0) // anchor
        };
        var lat = site.latitude[1];
        var lng = site.longitude[1];
        var mapProp = {
            center: new google.maps.LatLng(lat, lng),
            zoom: 8,
            mapTypeId: google.maps.MapTypeId.ROADMAP,
            styles: [{
                "featureType": "administrative",
                "elementType": "labels.text.fill",
                "stylers": [{
                    "color": "#444444"
                }]
            }, {
                "featureType": "landscape",
                "elementType": "all",
                "stylers": [{
                    "color": "#f2f2f2"
                }]
            }, {
                "featureType": "poi",
                "elementType": "all",
                "stylers": [{
                    "visibility": "off"
                }]
            }, {
                "featureType": "road",
                "elementType": "all",
                "stylers": [{
                    "saturation": -100
                }, {
                    "lightness": 45
                }]
            }, {
                "featureType": "road.highway",
                "elementType": "all",
                "stylers": [{
                    "visibility": "simplified"
                }]
            }, {
                "featureType": "road.arterial",
                "elementType": "labels.icon",
                "stylers": [{
                    "visibility": "off"
                }]
            }, {
                "featureType": "transit",
                "elementType": "all",
                "stylers": [{
                    "visibility": "off"
                }]
            }, {
                "featureType": "water",
                "elementType": "all",
                "stylers": [{
                    "color": "#46bcec"
                }, {
                    "visibility": "on"
                }]
            }]
        };

        // creating map object
        map = new google.maps.Map(document.getElementById("sitesMap"), mapProp);
        // adding markers on the map
        var contentString = '<div id="content">' +
            '<div id="geo_site">' +
            '</div>' +
            '<h3 id="firstHeading" class="firstHeading">'+site.name[1]+'</h3>' +
            '<div id="bodyContent">' +
            '<p><b>Status:</b>&nbsp;'+site.site_status[1]+'</p>' +
            '<p><b>Last Seen:</b>&nbsp;'+site.last_seen[1]+'</p>' +
            '<p>'+site.city[1]+',&nbsp;'+site.state[1]+'</p>' +
            '</div>' +
            '</div>';

        var markPosition = new google.maps.LatLng(lat, lng);
        var marker = new google.maps.Marker({
            position: markPosition,
            icon: icon
        });
        marker.setMap(map);
        // Showing site details on marker click
        google.maps.event.addListener(marker, 'click', function() {
            var infowindow = new google.maps.InfoWindow({
                content: contentString
            });
            //map.setZoom(15); // zoom the location
            smoothZoom(map, 15, map.getZoom());
            infowindow.open(map, marker);
        });
        function smoothZoom (map, max, cnt) {
                if (cnt >= max) {
                    return;
                }
                else {
                    z = google.maps.event.addListener(map, 'zoom_changed', function(event){
                        google.maps.event.removeListener(z);
                        smoothZoom(map, max, cnt + 1);
                    });
                    setTimeout(function(){map.setZoom(cnt)}, 80); // 80ms is what I found to work well on my system -- it might not work well on all systems
                }
            }
        }
    }
</script>

<!--Google Maps API -->
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC2jIUfDq0QUVMJF5Y6y-cYlSHNuGp-DvU&callback=myMap&style=feature:administrative%7Celement:geometry%7Cvisibility:off&style=feature:poi%7Cvisibility:off&style=feature:road%7Cvisibility:off&style=feature:road%7Celement:labels.icon%7Cvisibility:off&style=feature:transit%7Cvisibility:off"></script>
 <!--Google Maps API -->

{% endblock %}