{% extends "layout.html" %} {% load static %}
{% block content %}
<!-- Begin Page Content -->
<style type="text/css">
#sitesMap {
    height: 400px;
    width: 900px;
    top: 20px;
    left: 100px;
}
.geolocation-details{
    padding-top: 15px;
    padding-bottom: 15px;
}
</style>
<div class="container-fluid">

    <!-- Page Heading -->
    <h1 class="h3 mb-4 text-gray-800">Station Map View</h1>
    <div class="col-sm-6">
        <span id="view_name" hidden>Map View</span>
        <div class="col-12 geolocation-details">
            <div class="row p-15">
                <select title="Industry" id="iList" class="form-control col-md-5 select" onchange="GetSites(this);">
                    {% for industry in industries %}
                    <option value={{industry.uuid}}>{{industry}}</option>
                    {% endfor %}
                </select>
                <br>
                <!--<span id="loader" style="visibility: hidden;">&nbsp;&nbsp;&nbsp;Please wait...&nbsp;<img src="/static/img/loader.gif" class="loader" height="20" width="20"></span>-->
                <span id="loader" style="visibility: hidden; padding:5px">&nbsp;&nbsp;&nbsp;Please wait...&nbsp;<img src="/static/img/loader.gif" class="loader" height="20" width="20"></span>
            </div>

            <p id="site_dd_p" hidden></p>
            <div class="row p-15" id="site_dd" style="display:none">
                <select id="sList" class="form-control col-5 select m-r-10"
                        onchange="GetSiteDetails(this);"></select>
            </div>

            <div class="panel-body" id="siteinfotable" hidden>
                <h3 id="site_name_header">Site Details</h3>
                <div class="table-responsive">
                    <table class="table">
                        <tbody id="records_table"> </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>


    <div class="col-sm-12" id="geo">
        <div id="sitesMap" class="col"></div>
    </div>


</div>
<!-- /.container-fluid -->
{% endblock %}
{% block scripts %}
<script type="text/javascript">
var loader = document.getElementById('loader');
    function GetSites(industry) {
        if (industry.value != null && industry.value != '')
        {
            var $sites = $("#sList");
            loader.style.visibility = "visible";
        $.ajax({
            url: "/dashboard/GetSites?industry=" + industry.value
        }).done(function(details) {
            $sites.empty(); // remove old options
            $.each(details.sites, function(key, value) {
                $sites.append($("<option></option>").attr("value", value.uuid).text(value.name));
            });
            if (details.sites.length > 0) {
                $("#site_dd").show();
                $('#site_dd_p').removeAttr('style').text('choose site for info.')
                $("#site_dd_p").show();
                GetSiteDetails(details.sites[0]);
                loader.style.visibility = "hidden";
            } else {
                $("#site_dd").hide();
                $("#geo").hide();
                $('#site_dd_p').css("color", "red").text('no site available under this industry')
                $("#site_dd_p").show();
                $('#siteinfotable').hide();
                loader.style.visibility = "hidden";
            }

        });
            }else{
                $("#site_dd").hide();
                $("#geo").hide();
                $("#site_dd_p").hide();
                $('#siteinfotable').hide();
                loader.style.visibility = "hidden";
            }
    }

    function GetSiteDetails(s) {
        var site;
        if (s.uuid == null) {
            site = s.value;
        } else {
            site = s.uuid;
        }
        loader.style.visibility = "visible";
        $.ajax({
            url: "/dashboard/GetSiteDetails?site=" + site
        }).done(function(details) {
            var lt = details.Latitude;
            var lg = details.Longitude;
            myMap(details);
            $('#geo').show();
        });
    }

    var map;
    function myMap(site) {
    if(typeof site === "undefined"){
        // do nothing
	  }else {
        var icon = {
            url: "/static/img/marker.png",
            scaledSize: new google.maps.Size(54, 35), // scaled size
            origin: new google.maps.Point(0, 0), // origin
            anchor: new google.maps.Point(0, 0) // anchor
        };
        var lat = site.Latitude;
        var lng = site.Longitude;
        var mapProp = {
            center: new google.maps.LatLng(lat, lng),
            zoom: 4,
            mapTypeId: google.maps.MapTypeId.ROADMAP,
            styles: [{
                "featureType": "administrative",
                "elementType": "labels.text.fill",
                "stylers": [{
                    "color": "#444444"
                }]
            }, {
                "featureType": "landscape",
                "elementType": "all",
                "stylers": [{
                    "color": "#f2f2f2"
                }]
            }, {
                "featureType": "poi",
                "elementType": "all",
                "stylers": [{
                    "visibility": "off"
                }]
            }, {
                "featureType": "road",
                "elementType": "all",
                "stylers": [{
                    "saturation": -100
                }, {
                    "lightness": 45
                }]
            }, {
                "featureType": "road.highway",
                "elementType": "all",
                "stylers": [{
                    "visibility": "simplified"
                }]
            }, {
                "featureType": "road.arterial",
                "elementType": "labels.icon",
                "stylers": [{
                    "visibility": "off"
                }]
            }, {
                "featureType": "transit",
                "elementType": "all",
                "stylers": [{
                    "visibility": "off"
                }]
            }, {
                "featureType": "water",
                "elementType": "all",
                "stylers": [{
                    "color": "#46bcec"
                }, {
                    "visibility": "on"
                }]
            }]
        };

        // creating map object
        map = new google.maps.Map(document.getElementById("sitesMap"), mapProp);
        // adding markers on the map
        var contentString = '<div id="content">' +
            '<div id="geo_site">' +
            '</div>' +
            '<h3 id="firstHeading" class="firstHeading">'+site.Industry+'</h2>' +
            '<h4 class="firstHeading">'+site.Name+'</h2>' +
            '<p><b>Industry Code:</b> '+site.Industry_code+'</p]>' +
            '<div id="bodyContent">' +
            '<p><b>Status:</b>&nbsp;'+site.Status+'</p>' +
            '<p>'+site.State_City+'</p>' +
            '<a href="/dashboard/station-info/'+site.Uuid+'" target="_blank"> More Info...</a>' +
            '</div>' +
            '</div>';

        var markPosition = new google.maps.LatLng(lat, lng);
        var marker = new google.maps.Marker({
            position: markPosition,
            icon: icon
        });
        marker.setMap(map);
        marker{{ forloop.counter }}.addListener('click', function() {
            map.setZoom(7); // on-click zoom
          map.setCenter(marker{{ forloop.counter }}.getPosition());
        });
        // Showing site details on marker click
        google.maps.event.addListener(marker, 'click', function() {
            var infowindow = new google.maps.InfoWindow({
                content: contentString
            });
            //map.setZoom(15); // zoom the location
            smoothZoom(map, 4, map.getZoom());
            infowindow.open(map, marker);
        });
        function smoothZoom (map, max, cnt) {
                if (cnt >= max) {
                    return;
                }
                else {
                    z = google.maps.event.addListener(map, 'zoom_changed', function(event){
                        google.maps.event.removeListener(z);
                        smoothZoom(map, max, cnt + 1);
                    });
                    setTimeout(function(){map.setZoom(cnt)}, 80); // 80ms is what I found to work well on my system -- it might not work well on all systems
                }
            }
        }
    }

</script>

<!--Google Maps API -->
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC2jIUfDq0QUVMJF5Y6y-cYlSHNuGp-DvU&callback=myMap&style=feature:administrative%7Celement:geometry%7Cvisibility:off&style=feature:poi%7Cvisibility:off&style=feature:road%7Cvisibility:off&style=feature:road%7Celement:labels.icon%7Cvisibility:off&style=feature:transit%7Cvisibility:on">

</script>

{% endblock %}
